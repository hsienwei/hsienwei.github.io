<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>雜物聚集地</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="工作上的筆記">
<meta property="og:type" content="website">
<meta property="og:title" content="雜物聚集地">
<meta property="og:url" content="http://hsienwei.github.io/page/6/index.html">
<meta property="og:site_name" content="雜物聚集地">
<meta property="og:description" content="工作上的筆記">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="雜物聚集地">
<meta name="twitter:description" content="工作上的筆記">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-7748617-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo logo-text" href="/">雜物聚集地</a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/atom.xml">Feed</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hsienwei.github.io"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer">
      <article id="post-專案中與cURL相關瀕繁當機處理記錄" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/30/專案中與cURL相關瀕繁當機處理記錄/">專案中與cURL相關瀕繁當機處理記錄</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2013/05/30/專案中與cURL相關瀕繁當機處理記錄/" class="article-date">
  <time datetime="2013-05-30T14:15:23.000Z" itemprop="datePublished">2013-05-30</time>
</a>
      
      
        <div class="article-comment-link-wrap">
          <a href="http://hsienwei.github.io/2013/05/30/專案中與cURL相關瀕繁當機處理記錄/#disqus_thread" class="article-comment-link">评论</a>
        </div>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>以下是專案中遇到的一個比較特別的問題 記錄如下</p>
<h3 id="問題">問題</h3><p>在某次上市的android版遊戲有瀕繁當機的狀況，通常是在進遊戲後不久，而這狀況在內部測試時並不常出現，且無發生在iOS版本  </p>
<h3 id="處理">處理</h3><ol>
<li>本次新上市版本增加公告功能<br>由cURL進行http連線取得公告設定，檔案與圖片此部分使用cocos2d-x extensions的network套件，遊戲本身server連線程式也由cURL寫成  </li>
<li><p>測得兩次進遊戲後當機(花三天測試出現兩次)，看似curl程式庫引發，錯誤訊息如下：  </p>
<pre><code>Fatal signal 11 (SIGSEGV) at 0x5103a793 (code=2)
I/DEBUG   (  135): <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>
I/DEBUG   (  135): Build fingerprint: 'samsung/GT-I9000/GT-I9000:2.3.5/GINGERBREAD/XXJVT:user/release-keys'
I/DEBUG   (  135): pid: 11056, tid: 11056  &gt;&gt;&gt; com.igs.salonbossworld <span class="variable">&lt;&lt;&lt;
I/DEBUG   (  135): signal 11 (SIGSEGV), code 2 (SEGV_ACCERR), fault addr 5103a793
……….
I/DEBUG   (  135):  d30 0000000000000000  d31 3ff0000000000000
I/DEBUG   (  135):  scr 60000010
I/DEBUG   (  135):
I/DEBUG   (  135):          #00  pc 005691b6  /mnt/asec/com.igs.salonbossworld-1/lib/libgame.so
I/DEBUG   (  135):          #01  pc 0056935e  /mnt/asec/com.igs.salonbossworld-1/lib/libgame.so
I/DEBUG   (  135):          #02  pc 0056a150  /mnt/asec/com.igs.salonbossworld-1/lib/libgame.so (curl_mvsnprintf)
I/DEBUG   (  135):          #03  pc 0055d014  /mnt/asec/com.igs.salonbossworld-1/lib/libgame.so (curl_failf)
I/DEBUG   (  135):          #04  pc 00556586  /mnt/asec/com.igs.salonbossworld-1/lib/libgame.so (curl_resolv_timeout)
I/DEBUG   (  135):          #05  pc 0056308a  /mnt/asec/com.igs.salonbossworld-1/lib/libgame.so (Curl_connect)</span>
</code></pre></li>
<li><p>以<code>curl_mvsnprintf</code>, <code>curl_failf</code>, <code>curl_resolv_timeout</code>部份作搜尋，查得幾篇技術文章有類似狀況如下<br><a href="http://sourceforge.net/p/curl/bugs/973/" target="_blank" rel="external">http://sourceforge.net/p/curl/bugs/973/</a><br><a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=617647" target="_blank" rel="external">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=617647</a><br>重點在使用cURL並在多執行緒狀況下<br>有篇文章說明這個狀況取決於os與thread的實作細節(回文的是官方人員)<br><a href="http://curl.haxx.se/mail/lib-2002-12/0103.html" target="_blank" rel="external">http://curl.haxx.se/mail/lib-2002-12/0103.html</a>  </p>
<blockquote>
<p>AFAIK, it isn’t always specified what happens with signals in a multi-threaded system, it depends on your OS and your thread implementation. Which thread receives the signal etc.  </p>
</blockquote>
<p> 另外官方有說明Multi-threading的相關問題<br> <a href="http://curl.haxx.se/libcurl/c/libcurl-tutorial.html#Multi-threading" target="_blank" rel="external">http://curl.haxx.se/libcurl/c/libcurl-tutorial.html#Multi-threading</a><br> 另有一篇中文說明文章  <a href="http://www.cppblog.com/tx7do/archive/2012/02/20/166048.html" target="_blank" rel="external">http://www.cppblog.com/tx7do/archive/2012/02/20/166048.html</a>  </p>
</li>
<li><p>依照文章說明有2種作法，一是使用CURLOPT_NOSIGNAL，缺點是會失去DNS Lookup timeout的能力，可用增加c-ares支援解決(但有文章指出某些android裝置會有問題  <a href="http://curl.haxx.se/mail/lib-2013-04/0276.html" target="_blank" rel="external">http://curl.haxx.se/mail/lib-2013-04/0276.html</a>)<br>另一個方法是保持同時間只有一個curl handle，缺點需要改動程式架構  </p>
</li>
<li><p>基於幾點推測當機可能符合該BUG，之所以說是推測是因為無法確認玩家當機的確切原因且測試時無法完全重現</p>
<ul>
<li>連server的程式都以pthread開執行緒並以curl程式庫作http連線，當遊戲剛進去有可能會更新信件與動態公告資料，此時多執行緒成立。  </li>
<li>由於取決於這個狀況取決於os與thread的實作，或許可以解釋為何iOS無該狀況發生，</li>
<li>猜測玩家之所以比較容易發生是因為玩家通常在信件上資料會比較多或者是玩家常處於不穩定網路狀況故較容易逾時。   </li>
</ul>
</li>
<li><p>討論後將android動態公告http連線方式由cURL改為android原生方法，新版上市後已無該狀況。</p>
</li>
</ol>

      
    </div>
  
  </div>
  
</article>


    
      <article id="post-修改cocos2d-x提供的build-native-sh" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/23/修改cocos2d-x提供的build-native-sh/">修改cocos2d-x提供的build_native.sh</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2013/05/23/修改cocos2d-x提供的build-native-sh/" class="article-date">
  <time datetime="2013-05-23T14:41:27.000Z" itemprop="datePublished">2013-05-23</time>
</a>
      
      
        <div class="article-comment-link-wrap">
          <a href="http://hsienwei.github.io/2013/05/23/修改cocos2d-x提供的build-native-sh/#disqus_thread" class="article-comment-link">评论</a>
        </div>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>在cocos2d-x專案中要編譯native code時會用到build_native.sh來做編譯，這個Bash腳本會使用NDK的ndk-build  </p>
<p>隨著專案越來越複雜有些需求需要特別去處理,以我自己的狀況來講，須要分為Debug與Release兩個版本以及分為國際版與韓國版，上述兩個部分都可以經由修改build_native.sh來達到，下面會分成幾個部分來說：</p>
<p>先列出幾個教學網站<br><a href="http://www.ibm.com/developerworks/cn/linux/l-bash-parameters.html" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/linux/l-bash-parameters.html</a><br><a href="http://linuxconfig.org/Bash_scripting_Tutorial#18-redirections" target="_blank" rel="external">http://linuxconfig.org/Bash_scripting_Tutorial#18-redirections</a><br><a href="http://linux.vbird.org/linux_basic/0340bashshell-scripts.php" target="_blank" rel="external">http://linux.vbird.org/linux_basic/0340bashshell-scripts.php</a><br>我都是有需要在去查</p>
<p>基本上這個部份我是在版本2.0.3加的  但是最新的2.1.3應該也可用</p>
<h2 id="選項修改">選項修改</h2><p>原本build_native.sh中的選項部分的程式碼如下<br>其實要不是因為要改這個部份我還不知道這個腳本有選項可以用  </p>
<pre><code><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">"sh"</span> OPTION; <span class="keyword">do</span>  
<span class="keyword">case</span> <span class="string">"<span class="variable">$OPTION</span>"</span> <span class="keyword">in</span>  
s)  
buildexternalsfromsource=<span class="number">1</span>  
;;  
h)  
usage  
<span class="built_in">exit</span> <span class="number">0</span>  
;;  
<span class="keyword">esac</span>  
<span class="keyword">done</span>  
</code></pre><p>上面的寫法主要是處理”-s”這種型態的選項，也就是說如果今天的的指令是長下面這樣：<br><code>bash build_native.sh  -s  xxx</code><br>就只會處理-s的部分。</p>
<p>原本是想說就再加一個選項，結果並不如我想的這樣簡單，基本上先看到下面跟ndk-build有關的程式碼如下  </p>
<pre><code><span class="string">"<span class="variable">$NDK_ROOT</span>"</span>/ndk-build -C <span class="string">"<span class="variable">$APP_ANDROID_ROOT</span>"</span> $* \
NDK_MODULE_PATH=<span class="variable">${COCOS2DX_ROOT}</span>:<span class="variable">${COCOS2DX_ROOT}</span>/cocos2dx/platform/third_party/android/<span class="built_in">source</span><span class="string">"  </span>
</code></pre><p>重點在於<code>$*</code>代表該腳本的所有參數，如果今天我用了一個ndk-build已經有的參數就會影響ndk-build的行為，如果用了一個沒有的又會說是一個invalid option。</p>
<p>此時有兩個做法  一個是把 $*拿掉，但是這樣有一個缺點，原本可以下如下指令<br><code>bash build_native.sh clean</code>，也就是<code>ndk-build clean</code>，就會變成不能用。</p>
<p>另一個做法就是在選項的部分作修改，以下是我的改法：</p>
<pre><code><span class="keyword">for</span> p <span class="keyword">in</span> $*
<span class="keyword">do</span>
     <span class="built_in">echo</span> <span class="string">"<span class="variable">$p</span>"</span>
     <span class="keyword">case</span> <span class="variable">$p</span> <span class="keyword">in</span>
          <span class="string">"kr"</span>)
               <span class="built_in">echo</span> <span class="string">"force build kr"</span>
               forcebuildkr=<span class="number">1</span>
               <span class="comment">#Can not pass this parameter to next call bash</span>
               ;;
          <span class="string">"debug"</span>)
               <span class="built_in">echo</span> <span class="string">"get debug"</span>
               debugflag=<span class="number">1</span>
               <span class="comment">#Can not pass this parameter to next call bash</span>
               ;;
          <span class="string">"-s"</span>)
               buildexternalsfromsource=<span class="number">1</span>
               param=<span class="string">"<span class="variable">$param</span><span class="variable">$p</span> "</span>
               ;;
          <span class="string">"-h"</span>)
               usage
               <span class="built_in">exit</span> <span class="number">0</span>
               ;;
          *)
               param=<span class="string">"<span class="variable">$param</span><span class="variable">$p</span> "</span>
               ;;
     <span class="keyword">esac</span>
<span class="keyword">done</span>  
</code></pre><p>這是另一種選項的做法，以上面提到的<code>bash build_native.sh  -s  xxx</code>，在這裡就會全都處理到，又由於我不想全部選項都傳到<code>ndk-build</code>，所以該傳的我就存在<code>$param</code>，再把<code>$</code>*改為<code>$param</code>即可，此時我已經可以透過選項來選擇我要怎樣的版本。</p>
<h2 id="利用Application-mk分不同的版本">利用Application.mk分不同的版本</h2><p>在最早的時候，我在分debug與release版的時候是直接去android.mk中修改CPPFLAG，後來覺得實在是太麻煩要改來改去，就採取我現在使用的方法</p>
<p>ndk-build有一個選項：<code>ndk-build NDK_APPLICATION_MK=</code>，可以讓你自己指定要使用的Application.mk，所以我將不同狀況需要的CPPFLAG設定寫到不同的Application.mk檔中，再依照選項不同設定不同的數值去決定到底要用哪一個，大概如下：</p>
<pre><code><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$debugflag</span>"</span> ]]; <span class="keyword">then</span>
     <span class="built_in">echo</span> <span class="string">"debug on!!"</span>
     <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$forcebuildkr</span>"</span> ]]; <span class="keyword">then</span>
          <span class="built_in">echo</span> <span class="string">"force build kr!!"</span>
          usedebugappmk=<span class="string">"<span class="variable">${APP_ANDROID_ROOT}</span>/jni/Application_debug_kr.mk"</span>
     <span class="keyword">else</span>
          <span class="built_in">echo</span> <span class="string">"build global!!"</span>
          usedebugappmk=<span class="string">"<span class="variable">${APP_ANDROID_ROOT}</span>/jni/Application_debug.mk"</span>
     <span class="keyword">fi</span>
<span class="keyword">else</span>
     <span class="built_in">echo</span> <span class="string">"debug off!!"</span>
     <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$forcebuildkr</span>"</span> ]]; <span class="keyword">then</span>
          <span class="built_in">echo</span> <span class="string">"force build kr!!"</span>
          usedebugappmk=<span class="string">"<span class="variable">${APP_ANDROID_ROOT}</span>/jni/Application_kr.mk"</span>
     <span class="keyword">else</span>
          <span class="built_in">echo</span> <span class="string">"build global!!"</span>
          usedebugappmk=<span class="string">"<span class="variable">${APP_ANDROID_ROOT}</span>/jni/Application.mk"</span>
     <span class="keyword">fi</span>
<span class="keyword">fi</span>
<span class="string">"<span class="variable">$NDK_ROOT</span>"</span>/ndk-build NDK_APPLICATION_MK=<span class="string">"<span class="variable">$usedebugappmk</span>"</span> -C <span class="string">"<span class="variable">$APP_ANDROID_ROOT</span>"</span> <span class="variable">$param</span> \
<span class="string">"NDK_MODULE_PATH=<span class="variable">${COCOS2DX_ROOT}</span>:<span class="variable">${COCOS2DX_ROOT}</span>/cocos2dx/platform/third_party/android/prebuilt"</span>
</code></pre><h2 id="控制資源">控制資源</h2><p>一般cocos2d-x專案的資源檔都放在Resource資料夾下，後來我遇到了某種情況是某些檔案只在android狀況下改變，所以我另外開個一個資料夾Resource_android，在原本的# copy resources腳本下，添加了一段處理android特有資源的程式：</p>
<pre><code><span class="comment"># copy ver android</span>
<span class="keyword">for</span> file <span class="keyword">in</span> <span class="string">"<span class="variable">$APP_ROOT</span>"</span>/Resource_android/*
<span class="keyword">do</span>
<span class="keyword">if</span> [ <span class="operator">-d</span> <span class="string">"<span class="variable">$file</span>"</span> ]; <span class="keyword">then</span>
    cp -rf <span class="string">"<span class="variable">$file</span>"</span> <span class="string">"<span class="variable">$APP_ANDROID_ROOT</span>"</span>/assets
<span class="keyword">fi</span>
<span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">$file</span>"</span> ]; <span class="keyword">then</span>
    cp <span class="string">"<span class="variable">$file</span>"</span> <span class="string">"<span class="variable">$APP_ANDROID_ROOT</span>"</span>/assets
<span class="keyword">fi</span>
<span class="keyword">done</span>
</code></pre><p>另外也可以將腳本寫在別的.sh中在去呼叫如下  </p>
<pre><code><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$debugflag</span>"</span> <span class="operator">-ne</span> <span class="number">1</span> ]]; <span class="keyword">then</span>
     <span class="built_in">echo</span> <span class="string">"delete .lua .bat .exe"</span>
     <span class="keyword">if</span> [ <span class="operator">-e</span> <span class="string">"del_lua.sh"</span> ]; <span class="keyword">then</span>
          ./del_lua.sh
     <span class="keyword">fi</span>
<span class="keyword">fi</span>
</code></pre><p>專案在做release版時會將lua檔全部刪除，這部分是寫在另一個.sh中。</p>

      
    </div>
  
    <footer class="article-footer">
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cocos2d-x/">cocos2d-x</a></li></ul>

    </footer>
  
  </div>
  
</article>


    
      <article id="post-JNI中是否需要自行呼叫DeleteLocalRef" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/22/JNI中是否需要自行呼叫DeleteLocalRef/">JNI中是否需要自行呼叫DeleteLocalRef</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2013/05/22/JNI中是否需要自行呼叫DeleteLocalRef/" class="article-date">
  <time datetime="2013-05-22T15:43:46.000Z" itemprop="datePublished">2013-05-22</time>
</a>
      
      
        <div class="article-comment-link-wrap">
          <a href="http://hsienwei.github.io/2013/05/22/JNI中是否需要自行呼叫DeleteLocalRef/#disqus_thread" class="article-comment-link">评论</a>
        </div>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>這是一個被問到我一時之間答不出來的問題，後來去找了一下</p>
<p>JNI電子書籍<br><a href="http://192.9.162.55/docs/books/jni/" target="_blank" rel="external">http://192.9.162.55/docs/books/jni/</a><br><a href="http://www.soi.city.ac.uk/~kloukin/IN2P3/material/jni.pdf" target="_blank" rel="external">http://www.soi.city.ac.uk/~kloukin/IN2P3/material/jni.pdf</a>  </p>
<p>下面是相關說明<br>引自 <a href="http://192.9.162.55/docs/books/jni/html/refs.html" target="_blank" rel="external">http://192.9.162.55/docs/books/jni/html/refs.html</a></p>
<blockquote>
<p>A local reference is valid only within the dynamic context of the native method that creates it, and only within that one invocation of the native method. All local references created during the execution of a native method will be freed once the native method returns.  </p>
<p>There are two ways to invalidate a local reference. As explained before, the virtual machine automatically frees all local references created during the execution of a native method after the native method returns. In addition, programmers may explicitly manage the lifetime of local references using JNI functions such as DeleteLocalRef.  </p>
<p>Why do you want to delete local references explicitly if the virtual machine automatically frees them after native methods return? A local reference keeps the referenced object from being garbage collected until the local reference is invalidated. The DeleteLocalRef call in MyNewString, for example, allows the intermediate array object, elemArr, to be garbage collected immediately. Otherwise the virtual machine will only be able to free the elemArr object after the native method that calls MyNewString (such as C.f above) returns.  </p>
</blockquote>
<p>基本上就是說</p>
<ul>
<li>Local Reference只在其創建方法的dynamic context內有效。</li>
<li>兩個狀況下Local Reference會失效：使用DeleteLocalRef，其創建方法返回時。</li>
<li>既然返回時會失效為啥要呼叫DeleteLocalRef，在於呼叫後就立刻允許VM回收而非等到方法返回之後。</li>
</ul>
<p>個人感覺，這跟java中將用完物件的ref設為null的感覺很像。</p>

      
    </div>
  
    <footer class="article-footer">
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jni/">jni</a></li></ul>

    </footer>
  
  </div>
  
</article>


    
      <article id="post-Android設定寄送夾帶附件的E-mail時附件無法使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/04/19/Android設定寄送夾帶附件的E-mail時附件無法使用/">Android設定寄送夾帶附件的E-mail時附件無法使用</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2013/04/19/Android設定寄送夾帶附件的E-mail時附件無法使用/" class="article-date">
  <time datetime="2013-04-19T15:01:26.000Z" itemprop="datePublished">2013-04-19</time>
</a>
      
      
        <div class="article-comment-link-wrap">
          <a href="http://hsienwei.github.io/2013/04/19/Android設定寄送夾帶附件的E-mail時附件無法使用/#disqus_thread" class="article-comment-link">评论</a>
        </div>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="問題起因">問題起因</h3><p>基本上使用常見的方法如下</p>
<pre><code>Intent i = <span class="keyword">new</span> Intent(Intent.ACTION_SEND);
i.setType(<span class="string">"image/jpeg"</span>);
i.putExtra(Intent.EXTRA_EMAIL  , <span class="keyword">new</span> <span class="built_in">String</span>[]{sendTarget});
i.putExtra(Intent.EXTRA_SUBJECT, sendSubject);
i.putExtra(Intent.EXTRA_TEXT   , sendText);
i.putExtra(Intent.EXTRA_STREAM, <span class="built_in">Uri</span>.parse(<span class="string">"file://"</span>+ filePath));
<span class="keyword">try</span> {
     curActivity.startActivity(Intent.createChooser(i, <span class="string">"Please select Email client"</span>));
} <span class="keyword">catch</span> (android.content.ActivityNotFoundException ex) {
    Toast.makeText(curActivity, <span class="string">"There are no email clients installed."</span>, Toast.LENGTH_SHORT).show();
}
</code></pre><p>問題出於我給的是Internal Storage的路徑，所以基本上當其它的應用程式要取用檔案時有有存取權限問題</p>
<h3 id="解決方式">解決方式</h3><p>copy一份到External Storage再用copy檔的路徑即可</p>
<pre><code>File externalPicPath = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES);
File dstFile = <span class="keyword">new</span> File(externalPicPath, <span class="string">"picture.png"</span>);
<span class="keyword">try</span>{
    FileInputStream <span class="keyword">in</span> = <span class="keyword">new</span> FileInputStream(filePath);
    FileOutputStream <span class="keyword">out</span> = <span class="keyword">new</span> FileOutputStream(dstFile);
    <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];
    <span class="keyword">int</span> len;
    <span class="keyword">while</span> ((len = <span class="keyword">in</span>.read(buf)) &gt; <span class="number">0</span>) {
        <span class="keyword">out</span>.write(buf, <span class="number">0</span>, len);
    }
    <span class="keyword">in</span>.close();
    <span class="keyword">out</span>.close();
}
<span class="keyword">catch</span>(IOException e)
{
    Toast.makeText(curActivity, <span class="string">"I/O Error."</span>, Toast.LENGTH_SHORT).show();
     <span class="keyword">return</span>;
}
</code></pre>
      
    </div>
  
    <footer class="article-footer">
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  
  </div>
  
</article>


    
      <article id="post-Unity練習：使用Texture-Packer自製簡易2D-Sprite物件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/">Unity練習：使用Texture Packer自製簡易2D Sprite物件</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/" class="article-date">
  <time datetime="2013-04-07T15:48:25.000Z" itemprop="datePublished">2013-04-07</time>
</a>
      
      
        <div class="article-comment-link-wrap">
          <a href="http://hsienwei.github.io/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/#disqus_thread" class="article-comment-link">评论</a>
        </div>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>這是一個基本的練習，記載練習中學到的一些東西，基本上公司專案是使用NGUI這個plugin。<br>檔案放在 <a href="https://github.com/hsienwei/Unity_2D_Sprite_Test" target="_blank" rel="external">https://github.com/hsienwei/Unity_2D_Sprite_Test</a><br>呈現畫面大概如下  </p>
<img src="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/b27c3e4548a2ec5a51d69c880381c09c-746777.png" alt="b27c3e4548a2ec5a51d69c880381c09c-746777.png" title="">
<img src="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/2f8385900ffdb08f8ec0603404810d1b-747761.png" alt="2f8385900ffdb08f8ec0603404810d1b-747761.png" title="">
<h2 id="Texture_Packer與JSON_Parser">Texture Packer與JSON Parser</h2><p>Texture Packer是一個功能很完整的工具軟體，可以讓你把一些分散的圖包成一個大圖，可以節省記憶體與加快讀取速度，在以前使用cocos2d-x時就常常在用，現在他也提供Unity 3D的格式，但以這個格式匯出的檔案基本上是一個JSON格式的檔案，只是副檔名存成txt，我想是因為Unity的TextAsset只能是.txt的檔案，另外在格式當中另外有JSON(Array)與JSON(Hash)都是JSON格式，主要差在Frame的資料是用array存或者是object存，Unity 3D的格式跟JSON(Hash)的內容是一樣的。</p>
<img src="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/44821a95d11d41671941ff6a4f99273e-750059.png" alt="[JSON(Hash) & Unity 3D]" title="[JSON(Hash) & Unity 3D]">
<img src="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/58f235ec98ad7704ff274a8bb16b46cf-751904.png" alt="[JSON(Array)]" title="[JSON(Array)]">
<p>確定為JSON格式後就是選擇parser，試了兩個現有的library(Asset store中也有但我沒試)  </p>
<p><a href="http://wiki.unity3d.com/index.php/JSONObject" target="_blank" rel="external">http://wiki.unity3d.com/index.php/JSONObject</a><br>這一個在讀Texture Packer的檔案時會有點問題，看了一下居然是無法處理空格囧，基本上要處理的話在<code>JSONObject.cs</code>中Line61加一行 <code>str = str.Replace(&quot; &quot;, &quot;&quot;);</code> 就可以解決，但是後來想想還是算了。  </p>
<p><a href="http://wiki.unity3d.com/index.php?title=UnityLitJSON" target="_blank" rel="external">http://wiki.unity3d.com/index.php?title=UnityLitJSON</a><br>這個是基於一個C#的JSON Library : LitJSON去做的，看了一下這個相關文件比較多而且比較便於使用。<br>他提供了兩個用法:  </p>
<ul>
<li>Mapping JSON to objects  </li>
<li>Readers and Writers  </li>
</ul>
<p>我用的是Mapping JSON to objects，比較接近我以前的經驗。<br>下面是LitJSON一些相關資料<br><a href="http://www.cnblogs.com/peiandsky/archive/2012/04/20/2459219.html" target="_blank" rel="external">http://www.cnblogs.com/peiandsky/archive/2012/04/20/2459219.html</a>  簡單介紹使用方法<br><a href="http://litjson.sourceforge.net/doc/manual.html" target="_blank" rel="external">http://litjson.sourceforge.net/doc/manual.html</a>  官方說明  </p>
<p>基本上上面的一些步驟有參考下面這兩篇<br><a href="http://blog.csdn.net/midashao/article/details/8220868" target="_blank" rel="external">http://blog.csdn.net/midashao/article/details/8220868</a>  Unity3D之结合TexturePacker使用显示贴图<br>但我用的不是JSON(Array) 且我用的LitJSON不是原版的，似乎有被加工處理<br><a href="http://tpathuis.tumblr.com/post/42501893370/texturepacker這一篇是Texture" target="_blank" rel="external">http://tpathuis.tumblr.com/post/42501893370/texturepacker這一篇是Texture</a> Packer中Unity 3D分類的Turtorial，這裡有一些Texture Packer的設定，我用的設定比較貼近這個，沒有開Allow rotation，但我有開Trim Mode。  </p>
<p>設定好後publish，就可以產出兩個檔案 一個txt檔一個png檔，將這兩個檔案放到unity project 中asset/resources資料夾中之後使用。<br>(註記一下如果要用Resources.Load()去讀檔案一定要放在名稱為”resources”的資料夾中)</p>
<h2 id="建立Mesh物件">建立Mesh物件</h2><p>2D Sprite由一個平面組成基本上只要兩個三角面，但Unity的內建的Plane有200個三角面，實在是多太多了，所以有必要自己弄一個面數較少的來使用。<br>要建立Mesh資料，可以使用Mesh Filter這個component，然後再設定Mesh的vertices, uv與triangles，我的設定內容如下連結：<br><a href="https://github.com/hsienwei/Unity_2D_Sprite_Test/blob/master/Assets/script/Plane.cs" target="_blank" rel="external">https://github.com/hsienwei/Unity_2D_Sprite_Test/blob/master/Assets/script/Plane.cs</a><br>我的做法是依照frame的資訊去設定vertices的寬高，跟NGUI的做法上不太一樣，NGUI的設定基本上寬高都是1*1，藉由調整Scale去調整為該frame的寬高，我的做法是設定vertices的位置為該frame的寬高，調整scale的話就是調整縮放比例。<br>至於uv的部分就是將座標值轉成0-1之間的數值，另外由於座標系統不一樣，必須將y軸做調整。  </p>
<p>另外要注意因為每個atlas都是一張圖，所以在atlas物件中有一個material欄位是用來對各個sprite物件設定renderer的material，這裡主要是因為想要減少drawcall，下面是相關資料的連結：<br><a href="http://docs.unity3d.com/Documentation/Manual/DrawCallBatching.html" target="_blank" rel="external">http://docs.unity3d.com/Documentation/Manual/DrawCallBatching.html</a><br>Dynamic Batching的條件中有一項是使用相同的Material，所以我從之前各個sprite都自己new material物件改為在atlas讀檔時new material，在sprite設定時再參照到atlas的material，由於sprite的頂點夠少，所以unity會自動幫我們處理batching。<br>(如果要自己使用batching script，在Import Package-&gt;script 匯入Standard Assets/Scripts/Utility Scripts內的兩個script)。</p>
<h2 id="editor">editor</h2><p>這個練習我寫了兩個主要的script，一個是atlas，另一個是Plane，這兩個我在做法上有點不同。<br>首先是atlas，他的畫面與部分程式碼如下<br><img src="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/e393420d2c4f67038433399b9f3741e3-753607.png" alt="e393420d2c4f67038433399b9f3741e3-753607.png" title=""><br><img src="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/a5783729a8ecd4c2dd0964bc2d311803-754879.png" alt="a5783729a8ecd4c2dd0964bc2d311803-754879.png" title=""></p>
<p>主要設定 TextAsset這個欄位，下面的一些資訊會自動生成(我這裡有一點bug，設定好TextAsset 後需要play一次下面的資訊才會出現)，基本上這邊我只有使用最簡單的方式，也就是在程式的部分設定為public，這些值就會出現在Inspector介面中供調整，TextAset以下的其實可以不要出現在Inspector，但為了方便看相關資訊所以讓他出現。  </p>
<p>下面的是Plane這個sprite<br><img src="/2013/04/07/Unity練習：使用Texture-Packer自製簡易2D-Sprite物件/f2d055e6a8a991cfb37d28fb3bd17184-755749.png" alt="f2d055e6a8a991cfb37d28fb3bd17184-755749.png" title=""></p>
<p>這一個主要是使用custom editor，自己寫一個editor的類別去處理這個script在Inspector中顯示的GUI介面，程式碼如下<br><a href="https://github.com/hsienwei/Unity_2D_Sprite_Test/blob/master/Assets/editor/PlaneEditor.cs" target="_blank" rel="external">https://github.com/hsienwei/Unity_2D_Sprite_Test/blob/master/Assets/editor/PlaneEditor.cs</a></p>
<p>可以參考一下editor類別的說明 <a href="http://docs.unity3d.com/Documentation/ScriptReference/Editor.html" target="_blank" rel="external">http://docs.unity3d.com/Documentation/ScriptReference/Editor.html</a><br>還有官方文件<a href="http://docs.unity3d.com/Documentation/Components/gui-ExtendingEditor.html" target="_blank" rel="external">http://docs.unity3d.com/Documentation/Components/gui-ExtendingEditor.html</a><br>相關教程 <a href="http://www.youtube.com/watch?v=WlGwBmM-dfA" target="_blank" rel="external">http://www.youtube.com/watch?v=WlGwBmM-dfA</a>  </p>
<p>自己記錄的幾個點</p>
<ul>
<li>要用custom editor 要在前面加上 [CustomEditor(typeof(CLASS))]</li>
<li>繼承 Editor</li>
<li>要放在editor資料夾</li>
<li>可以使用OnEnable, OnInspectorGUI兩個方法，OnEnable會在該GUI出現時執行一次，OnInspectorGUI會執行數次(我還不確定次數的根據)</li>
<li>如果改了Scene裡的物件屬性有時候不會及時更新，可呼叫SceneView.RepaintAll();</li>
<li>可用GUI.changed去判定是否有變更過屬性</li>
<li>基本上你在GUI修改數值是不會被存起來的(play時或play完就會回到原樣)，需要用EditorUtility.SetDirty告訴Unity存起來</li>
<li>使用target存取目標物件  </li>
<li>可以使用SerializedObject輔助，修改target時SerializedObject取property會是改變前的數值(相關討論 <a href="http://answers.unity3d.com/questions/43611/oninspectorgui-using-the-default-object-selection.html" target="_blank" rel="external">http://answers.unity3d.com/questions/43611/oninspectorgui-using-the-default-object-selection.html</a>)  </li>
</ul>
<p>大概就是這樣，這個練習應該還有一些bug，但基本上我學了不少</p>

      
    </div>
  
  </div>
  
</article>


    
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/page/5/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/">下一页 &raquo;</a>
      </nav>
    </section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Hsien-Wei Hsiang&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    
<script>
  var disqus_shortname = 'hsienwei';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>
  </div>
</body>
</html>